<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>GéoMaurice – Carte d’accessibilité</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

    <style>
        #map {
            height: 100vh;
        }

        #control-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 9999;
            max-height: 95vh;
            overflow-y: scroll;
            width: 300px;
        }

        .label-block {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>

    <div id="control-panel">
        <h3>Paramètres du score</h3>
        <div id="control-content"></div>
        <button onclick="updateHeatmap()">Recalculer score</button>
    </div>

    <div id="map"></div>

    <script>
        // -----------------------------------------------------------------------------
        // 1) Définition des labels par catégorie
        // -----------------------------------------------------------------------------

        const GROUPS = {
            health: ["hospital", "clinic", "doctors", "dentist", "pharmacy", "nursing_home", "social_facility", "first_aid", "blood_donation"],
            security: ["police", "fire_station", "ambulance_station", "rescue_station", "lifeguard", "lifeguard_tower"],
            education: ["school", "kindergarten", "college", "university", "library"],
            public: ["townhall", "courthouse", "embassy", "community_centre", "public_building", "government", "post_office", "post_box"],
            transport: ["bus_station", "bus_stop", "taxi", "ferry_terminal", "fuel", "charging_station", "parking", "bicycle_parking", "motorcycle_parking"],
            hygiene: ["drinking_water", "toilets", "shower", "water_point", "waste_disposal", "recycling"],
            commercial: ["marketplace", "bank", "atm", "vending_machine", "money_transfer"],
            tourism: ["restaurant", "fast_food", "cafe", "bar", "pub", "ice_cream"]
        };

        // -----------------------------------------------------------------------------
        // 2) Carte Leaflet
        // -----------------------------------------------------------------------------

        const map = L.map('map').setView([-20.2, 57.5], 11);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let POINT_LAYERS = {};          // affichage des points
        let AMENITY_DATA = {};          // données chargées
        let heatLayer = null;

        // -----------------------------------------------------------------------------
        // 3) Charger dynamiquement les GeoJSON
        // -----------------------------------------------------------------------------

        async function loadAmenity(label) {
            const url = `data/osm/${label}.geojson`;
            const res = await fetch(url);
            const gj = await res.json();
            AMENITY_DATA[label] = gj;

            // Ajouter au groupe de points
            POINT_LAYERS[label] = L.geoJSON(gj, {
                pointToLayer: (f, latlng) => L.circleMarker(latlng, {
                    radius: 4, color: "blue", fillOpacity: 0.7
                })
            }).addTo(map);
        }

        // Charger tous les labels
        (async () => {
            for (const cat in GROUPS) {
                for (const label of GROUPS[cat]) {
                    await loadAmenity(label);
                }
            }
        })();

        // -----------------------------------------------------------------------------
        // 4) Génération de l’UI (checkbox + slider)
        // -----------------------------------------------------------------------------

        const ui = document.getElementById("control-content");

        function createUI() {
            for (const cat in GROUPS) {
                const h = document.createElement("h4");
                h.textContent = cat;
                ui.appendChild(h);

                GROUPS[cat].forEach(label => {
                    const div = document.createElement("div");
                    div.className = "label-block";
                    div.innerHTML = `
                <b>${label}</b><br>
                <input type="checkbox" id="show_${label}" checked> Afficher<br>
                <input type="checkbox" id="use_${label}" checked> Inclure score<br>
                Poids : <input type="range" id="w_${label}" min="0" max="2" step="0.1" value="1">
                <span id="w_val_${label}">1</span>
            `;
                    ui.appendChild(div);

                    document.getElementById(`w_${label}`).oninput = (e) => {
                        document.getElementById(`w_val_${label}`).textContent = e.target.value;
                    };
                });
            }
        }
        createUI();

        // -----------------------------------------------------------------------------
        // 5) Calcul du score : distance + poids + activation
        // -----------------------------------------------------------------------------

        function dist(a, b) {
            const R = 6371000;
            const dLat = (b[0] - a[0]) * Math.PI / 180;
            const dLon = (b[1] - a[1]) * Math.PI / 180;
            const x = dLon * Math.cos((a[0] + b[0]) * Math.PI / 360);
            return Math.sqrt(dLat * dLat + x * x) * R;
        }

        function bias(d) {
            return Math.exp(-d / 500);     // pénalise > 500m
        }

        // -----------------------------------------------------------------------------
        // 6) Recalcul dynamique de la heatmap
        // -----------------------------------------------------------------------------

        function updateHeatmap() {
            if (heatLayer) map.removeLayer(heatLayer);

            const pts = [];

            for (let lat = -20.55; lat <= -19.95; lat += 0.00001) {
                for (let lon = 57.3; lon <= 57.8; lon += 0.00001) {

                    let score = 0;

                    for (const cat in GROUPS) {
                        for (const label of GROUPS[cat]) {

                            const show = document.getElementById(`show_${label}`).checked;
                            const use = document.getElementById(`use_${label}`).checked;
                            const w = parseFloat(document.getElementById(`w_${label}`).value);

                            // Affichage des points
                            if (POINT_LAYERS[label]) {
                                if (show) POINT_LAYERS[label].addTo(map);
                                else map.removeLayer(POINT_LAYERS[label]);
                            }

                            if (!use) continue;        // pas intégré au score
                            if (!AMENITY_DATA[label]) continue;

                            const coords = AMENITY_DATA[label].features.map(f =>
                                [f.geometry.coordinates[1], f.geometry.coordinates[0]]
                            );

                            if (!coords.length) continue;

                            const d = Math.min(...coords.map(c => dist([lat, lon], c)));
                            score += w * bias(d);
                        }
                    }

                    pts.push([lat, lon, score]);
                }
            }

            heatLayer = L.heatLayer(pts, { radius: 18, blur: 15 }).addTo(map);
        }

    </script>

</body>

</html>